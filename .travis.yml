dist: bionic
language: rust
sudo: false

branches:
  except:
    - /^v[0-9]/

matrix:
  include:
    - os: linux
      rust: stable
      addons:
        apt:
          packages:
            - libcurl4-openssl-dev
            - libelf-dev
            - libdw-dev
            - cmake
            - gcc
            - binutils-dev
            - libiberty-dev
      env:
        - TARGET=x86_64-unknown-linux-gnu
        - COVERAGE=kcov

    - os: linux
      rust: nightly
      env: TARGET=x86_64-unknown-linux-gnu

    - os: osx
      rust: stable
      env: TARGET=x86_64_apple-darwin

script:
  - cargo check
  - cargo test

after_success:
  - if [ "$COVERAGE" != "kcov" ]; then travis_terminate 0; fi
  - echo "Install kcov"
  - wget https://github.com/SimonKagstrom/kcov/archive/master.tar.gz
  - tar xzf master.tar.gz
  - cd kcov-master
  - mkdir build
  - cd build
  - cmake ..
  - make
  - make install DESTDIR=../../kcov-build
  - cd ../..
  - rm -rf kcov-master
  - echo "Install cargo-kcov"
  - cargo install cargo-kcov
  - echo "Run kcov"
  - ./kcov-build/usr/local/bin/kcov --version
  - cargo kcov -v --kcov ./kcov-build/usr/local/bin/kcov --no-clean-rebuild -- --include-pattern="$PWD/src" --exclude-region='#[cfg(test)]:'
  - echo "Fix coverage"
  - cargo run
  - echo "Upload coverage to codecov"
  - bash <(curl -s https://codecov.io/bash) -f ./target/cov/kcov-merged/cobertura.xml
  - echo "Uploaded code coverage"

notifications:
  email: false
